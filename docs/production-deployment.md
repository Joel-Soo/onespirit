# OneSpirit Production Deployment Guide

This guide covers deploying OneSpirit to a production environment using Docker Compose with nginx-proxy and Let's Encrypt SSL certificates.

## Overview

The production setup includes:
- **Nginx Proxy**: Automatic reverse proxy with SSL termination
- **Let's Encrypt**: Automatic SSL certificate management
- **PostgreSQL 16**: Production database
- **Redis 7**: Caching layer for improved performance
- **Gunicorn**: Production WSGI server
- **OneSpirit Web**: Django application

## Architecture Changes from Misago

The production docker-compose has been adapted from Misago with the following changes:

### Removed Services
- **Celery Worker**: Not needed (OneSpirit doesn't use async tasks)
- **Redis 6**: Upgraded to Redis 7

### Updated Services
- **postgres-15** → **postgres**: Using PostgreSQL 16-alpine
- **misago** → **web**: Renamed to match development setup
- **Network**: Changed from `misago` to `onespirit_network`

### Added Features
- Health checks for all critical services
- Non-root user in production containers
- Separate production Dockerfile with multi-stage build
- Automated backup/restore scripts
- Improved logging configuration

## Prerequisites

1. **Server Requirements**:
   - Ubuntu 20.04+ or similar Linux distribution
   - Docker 20.10+ and Docker Compose v2+
   - At least 2GB RAM (4GB recommended)
   - 20GB disk space minimum

2. **Domain Configuration**:
   - Domain name pointing to your server's IP address
   - DNS A records configured for your domain
   - Ports 80 and 443 open in firewall

## Initial Setup

### 1. Clone and Configure

```bash
# Clone the repository
git clone <repository-url>
cd onespirit

# Copy the production environment file
cp .env.prod.example .env.prod

# Edit the configuration
nano .env.prod
```

### 2. Configure Environment Variables

Edit `.env.prod` and update the following **required** values:

```bash
# Generate a secure secret key
SECRET_KEY=$(python -c 'from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())')

# Your domain
VIRTUAL_HOST=yourdomain.com
LETSENCRYPT_HOST=yourdomain.com,www.yourdomain.com
LETSENCRYPT_EMAIL=admin@yourdomain.com

# Allowed hosts
ALLOWED_HOSTS=yourdomain.com,www.yourdomain.com

# Database credentials (use strong passwords!)
DB_NAME=onespirit_production
DB_USER=onespirit_prod_user
DB_PASSWORD=<generate-secure-password>
```

### 3. Initialize Production Environment

```bash
# Make setup script executable (if not already)
chmod +x setup-prod.sh

# Initialize the production environment
./setup-prod.sh init
```

This will:
- Build production Docker images
- Start PostgreSQL and Redis
- Run database migrations
- Collect static files

### 4. Create Admin User

```bash
./setup-prod.sh createsuperuser
```

### 5. Start All Services

```bash
./setup-prod.sh up
```

Your application will be available at:
- **HTTP**: `http://yourdomain.com` (redirects to HTTPS)
- **HTTPS**: `https://yourdomain.com`

SSL certificates will be automatically generated by Let's Encrypt.

## Production Setup Script Commands

The `setup-prod.sh` script provides convenient commands for managing production:

```bash
# View all available commands
./setup-prod.sh

# Common operations
./setup-prod.sh up              # Start all services
./setup-prod.sh down            # Stop all services
./setup-prod.sh restart         # Restart web application
./setup-prod.sh logs            # View application logs
./setup-prod.sh status          # Check service status

# Database operations
./setup-prod.sh migrate         # Run migrations
./setup-prod.sh backup-db       # Create database backup
./setup-prod.sh restore-db <file> # Restore from backup

# Maintenance
./setup-prod.sh collectstatic   # Collect static files
./setup-prod.sh shell           # Open Django shell
./setup-prod.sh bash            # Open bash in container
./setup-prod.sh ssl-renew       # Manually renew SSL certificate
```

## File Structure

```
onespirit/
├── docker-compose.prod.yaml    # Production services configuration
├── Dockerfile.prod             # Production container image
├── setup-prod.sh               # Production management script
├── .env.prod.example           # Template for production env vars
├── .env.prod                   # Your actual env vars (gitignored)
├── config/
│   └── nginx/                  # Custom nginx configuration
├── logs/
│   ├── nginx/                  # Nginx logs
│   ├── gunicorn-access.log     # Gunicorn access logs
│   └── gunicorn-error.log      # Gunicorn error logs
├── backups/                    # Database backups
├── onespirit/
│   ├── media/                  # User-uploaded files
│   └── static/                 # Collected static files
└── staticfiles/                # Django collected static files
```

## Database Management

### Creating Backups

Automated backup:
```bash
./setup-prod.sh backup-db
```

Backups are stored in `backups/` directory with timestamp:
```
backups/db_backup_20241110_143022.sql.gz
```

### Restoring from Backup

```bash
./setup-prod.sh restore-db backups/db_backup_20241110_143022.sql.gz
```

**Warning**: This will overwrite the current database. You'll be asked to confirm.

### Manual Database Access

```bash
# Access PostgreSQL directly
docker compose -f docker-compose.prod.yaml exec postgres psql \
  -U onespirit_prod_user -d onespirit_production
```

## Monitoring and Logs

### View Logs

```bash
# Follow web application logs
./setup-prod.sh logs

# View specific service logs
docker compose -f docker-compose.prod.yaml logs -f postgres
docker compose -f docker-compose.prod.yaml logs -f redis
docker compose -f docker-compose.prod.yaml logs -f nginx-proxy

# View all logs
docker compose -f docker-compose.prod.yaml logs -f
```

### Log Files

Application logs are stored in the `logs/` directory:
- `logs/gunicorn-access.log`: HTTP request logs
- `logs/gunicorn-error.log`: Application error logs
- `logs/django.log`: Django application logs
- `logs/nginx/`: Nginx access and error logs

## SSL/TLS Configuration

SSL certificates are automatically obtained and renewed by Let's Encrypt.

### Certificate Locations

Certificates are stored in Docker volumes:
- `nginx-certs`: SSL certificates and keys
- `acme-state`: Let's Encrypt account state

### Manual Renewal

Certificates automatically renew. To force renewal:
```bash
./setup-prod.sh ssl-renew
```

### Troubleshooting SSL

1. Ensure DNS is properly configured
2. Check Let's Encrypt logs:
   ```bash
   docker compose -f docker-compose.prod.yaml logs nginx-letsencrypt
   ```
3. Verify domain is accessible on port 80 (required for verification)

## Updating the Application

### Rolling Update (Zero Downtime)

```bash
# Pull latest code
git pull origin main

# Rebuild images
./setup-prod.sh build

# Run migrations (if any)
./setup-prod.sh migrate

# Collect static files
./setup-prod.sh collectstatic

# Restart the application
./setup-prod.sh restart
```

### Full Restart

```bash
git pull origin main
./setup-prod.sh down
./setup-prod.sh build
./setup-prod.sh up
```

## Performance Tuning

### Gunicorn Workers

Edit `Dockerfile.prod` to adjust worker configuration:

```dockerfile
CMD ["gunicorn", \
     "--workers", "4",      # 2-4x CPU cores
     "--threads", "2",      # 2-4 threads per worker
     "--timeout", "60",     # Request timeout
     ...
]
```

**Formula**: `workers = (2 × CPU cores) + 1`

### Redis Configuration

Redis is configured with persistence (AOF). To adjust:

```yaml
# In docker-compose.prod.yaml
redis:
  command: redis-server --appendonly yes --maxmemory 256mb
```

### PostgreSQL Tuning

For better performance, consider adjusting PostgreSQL settings:

```yaml
postgres:
  command: postgres -c shared_buffers=256MB -c max_connections=200
```

## Security Considerations

### 1. Environment Variables

- **Never** commit `.env.prod` to version control
- Use strong, unique passwords for database
- Rotate SECRET_KEY periodically

### 2. Firewall

Only expose necessary ports:
```bash
ufw allow 80/tcp
ufw allow 443/tcp
ufw allow 22/tcp  # SSH only
ufw enable
```

### 3. Regular Updates

Keep system and Docker updated:
```bash
apt update && apt upgrade
docker compose -f docker-compose.prod.yaml pull
```

### 4. Backups

Schedule automated backups:
```bash
# Add to crontab
0 2 * * * cd /path/to/onespirit && ./setup-prod.sh backup-db
```

## Troubleshooting

### Application Won't Start

1. Check service status:
   ```bash
   ./setup-prod.sh status
   ```

2. View logs for errors:
   ```bash
   ./setup-prod.sh logs
   ```

3. Verify environment variables:
   ```bash
   docker compose -f docker-compose.prod.yaml config
   ```

### Database Connection Issues

1. Check PostgreSQL is healthy:
   ```bash
   docker ps --filter name=onespirit_postgres_prod
   ```

2. Test database connection:
   ```bash
   docker compose -f docker-compose.prod.yaml exec postgres \
     pg_isready -U onespirit_prod_user
   ```

### SSL Certificate Issues

1. Check Let's Encrypt logs
2. Ensure ports 80/443 are open
3. Verify DNS records
4. Check domain is in LETSENCRYPT_HOST

### Performance Issues

1. Check resource usage:
   ```bash
   docker stats
   ```

2. Review Gunicorn worker count
3. Check Redis memory usage
4. Analyze slow queries in PostgreSQL

## Migration from Development

To migrate from development to production:

1. **Export development data**:
   ```bash
   ./setup.sh manage dumpdata > data.json
   ```

2. **Import to production**:
   ```bash
   ./setup-prod.sh bash
   python manage.py loaddata /app/data.json
   ```

## Additional Resources

- [Django Deployment Checklist](https://docs.djangoproject.com/en/stable/howto/deployment/checklist/)
- [Gunicorn Configuration](https://docs.gunicorn.org/en/stable/settings.html)
- [Let's Encrypt Documentation](https://letsencrypt.org/docs/)
- [PostgreSQL Performance Tuning](https://wiki.postgresql.org/wiki/Performance_Optimization)

## Support

For issues or questions:
1. Check logs first: `./setup-prod.sh logs`
2. Review this documentation
3. Check the project's issue tracker
4. Contact the development team

---

Last Updated: 2025-11-10
