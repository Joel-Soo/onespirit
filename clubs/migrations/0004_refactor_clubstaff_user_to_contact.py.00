# Generated by Antigravity

from django.db import migrations, models
import django.db.models.deletion

def migrate_user_to_contact(apps, schema_editor):
    ClubStaff = apps.get_model('clubs', 'ClubStaff')
    # We need to access the related LoginUser to get the contact
    # Since 'user' field is still there, we can use it.
    for staff in ClubStaff.objects.all():
        if staff.user and hasattr(staff.user, 'contact'):
            staff.contact = staff.user.contact
            staff.save()

def reverse_migrate_user_to_contact(apps, schema_editor):
    ClubStaff = apps.get_model('clubs', 'ClubStaff')
    for staff in ClubStaff.objects.all():
        if staff.contact and hasattr(staff.contact, 'login_user'):
             staff.user = staff.contact.login_user
             staff.save()

class Migration(migrations.Migration):

    dependencies = [
        ('clubs', '0003_add_club_name_uniqueness_constraint'),
        ('people', '0005_remove_is_club_owner_field'),
    ]

    operations = [
        # 1. Add contact field (nullable initially)
        migrations.AddField(
            model_name='clubstaff',
            name='contact',
            field=models.ForeignKey(
                to='people.contact',
                null=True,
                on_delete=django.db.models.deletion.CASCADE,
                related_name='club_assignments_temp'
            ),
        ),
        
        # 2. Migrate data
        migrations.RunPython(migrate_user_to_contact, reverse_migrate_user_to_contact),
        
        # 3. Remove old unique constraint
        migrations.RemoveConstraint(
            model_name='clubstaff',
            name='unique_staff_assignment_per_club'
        ),
        
        # 4. Remove old index
        migrations.RemoveIndex(
            model_name='clubstaff',
            name='clubs_clubs_user_id_18f863_idx'
        ),

        # 5. Remove user field
        migrations.RemoveField(
            model_name='clubstaff',
            name='user',
        ),

        # 6. Alter contact to be non-nullable and set correct related_name
        migrations.AlterField(
            model_name='clubstaff',
            name='contact',
            field=models.ForeignKey(
                to='people.contact',
                null=False,
                on_delete=django.db.models.deletion.CASCADE,
                related_name='club_assignments'
            ),
        ),

        # 7. Add new unique constraint
        migrations.AddConstraint(
            model_name='clubstaff',
            constraint=models.UniqueConstraint(fields=('club', 'contact'), name='unique_staff_assignment_per_club'),
        ),

        # 8. Add new index
        migrations.AddIndex(
            model_name='clubstaff',
            index=models.Index(fields=['contact', 'is_active'], name='clubs_clubs_contact_idx'),
        ),
    ]
